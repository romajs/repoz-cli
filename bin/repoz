#!/usr/bin/env node

// 'use strict';

const fs = require('fs');
const os = require('os');
const winston = require('winston');
var program = require('commander');
var prompt = require('prompt');
var q = require('q');
var repoz = require('../lib/repoz');

var p = os.homedir() + '/.repoz';
if(!fs.existsSync(p)) {
	fs.mkdirSync(p);
}

var f = p + '/credentials.json';
if(!fs.existsSync(f)) {
	fs.writeFileSync(f, '[]\n');
}

const AT_READ = 0, AT_WRITE = 1;

const ACCESS_TYPES = {
	get : AT_READ,
	post : AT_WRITE,
	put : AT_WRITE,
	delete : AT_WRITE,
	list : AT_READ,
};

parseArgs(process.argv).then(function(args) {

	winston.info(args);

	getCredential(args.project, ACCESS_TYPES[args.command]).then(function(credential) {

		var r = repoz(args.project, credential.username, credential.password);
		var command = r[args.command];

		if(command === undefined) {
			winston.info('Command "%s" not found.', args.command);
			process.exit(1);
		}

		command.apply(this, [args.path, args.filepath]).then(function() {
			saveCredential(credential);
			winston.info('done.');
			process.exit(0);
		}).catch(function(err) {
			winston.error('failed.', err);
			process.exit(1);
		});

	});

});

function parseArgs(argv) {

	var d = q.defer();

	program.version('0.0.1')
		.option('-p, --project [project]', 'Project')
		.arguments('<command> [path] [filepath]')
		.action(function (command, path, filepath) {
			d.resolve({
				project: program.project,
				command: command,
				path: path,
				filepath: filepath,
			});
		})
		.parse(argv);

	return d.promise;
}

function saveCredential(credential) {
	var credentials = JSON.parse(fs.readFileSync(f));
	credentials.push(credential);
	fs.writeFileSync(f, JSON.stringify(credentials) + '\n');
	winston.info('credentials saved.');
}

function getCredential(project, access_type) {

	var d = q.defer();

	findCredential(project, access_type).then(function(credentials) {

		if(credentials) {
			d.resolve(credentials);
		} else {
			askCredential().then(function(credentials) {
				credentials.project = project;
				credentials.access_type = access_type;
				d.resolve(credentials);
			});
		}
	})

	return d.promise;
}

function findCredential(project, access_type) {

	var d = q.defer();

	var credentials = JSON.parse(fs.readFileSync(f));

	var credential = credentials.find(function(credential) {
		return credential.project === project && credential.access_type >= access_type;
	})

	d.resolve(credential);

	return d.promise;
}

function askCredential() {

	var d = q.defer();

	var properties = [
		{ name: 'username' },
		{ name: 'password', hidden: true }
	];

	prompt.get(properties, function (err, credentials) {
		if (err) {
			d.reject(err);
		} else {
			d.resolve(credentials);
		}
	});

	prompt.start();

	return d.promise;
}